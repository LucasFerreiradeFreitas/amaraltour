<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Amaraltour</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --color-primary: #d4af37;
      --color-primary-dark: #b8860b;
      --color-secondary: #8b4513;
      --color-text: #4a2c0f;
      --color-border: #e2e8f0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      min-height: 100vh;
    }

    /* LOGIN */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .login-box {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-box h2 {
      color: var(--color-secondary);
      margin-bottom: 1rem;
    }

    .login-box p {
      color: #666;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    .login-box input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--color-border);
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.875rem;
      width: 100%;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--color-primary-dark);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      color: #dc2626;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }

    .login-info {
      color: #3b82f6;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }

    /* ADMIN PANEL - Mesmo estilo do admin-seguro.html */
    #admin-panel {
      display: none;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .alert {
      background: #d1fae5;
      border: 2px solid #10b981;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 2rem;
      color: #065f46;
    }

    .header {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header h1 {
      color: var(--color-text);
      font-size: 1.75rem;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-secondary {
      background: var(--color-secondary);
      color: white;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .content {
      background: white;
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .trips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .trip-card {
      border: 2px solid var(--color-border);
      border-radius: 0.75rem;
      padding: 1.5rem;
    }

    .trip-card h3 {
      color: var(--color-text);
      margin-bottom: 0.5rem;
    }

    .trip-card .date {
      color: #6b7280;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .trip-card .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .status.available {
      background: #10b981;
      color: white;
    }

    .status.sold-out {
      background: #ef4444;
      color: white;
    }

    .trip-card .actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .trip-card .actions button {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.875rem;
    }

    #empty-state {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }

    #loading {
      text-align: center;
      padding: 3rem;
      color: var(--color-primary);
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 0.75rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      margin-bottom: 1.5rem;
      color: var(--color-text);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--color-border);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .image-upload {
      border: 2px dashed var(--color-border);
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
    }

    .image-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 1rem;
      border-radius: 0.5rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .modal-actions button {
      flex: 1;
    }

    #export-section {
      display: none;
      margin-top: 2rem;
      padding: 1.5rem;
      background: #f3f4f6;
      border-radius: 0.5rem;
    }

    #export-section textarea {
      width: 100%;
      min-height: 200px;
      padding: 1rem;
      border: 2px solid var(--color-border);
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
    }

    #export-section .btn-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    #export-section .btn-group button {
      flex: 1;
    }
  </style>
</head>

<body>
  <!-- TELA DE LOGIN -->
  <div id="login-screen">
    <div class="login-box">
      <h2>üîê Admin Amaraltour</h2>
      <p>Autentica√ß√£o via Netlify Function</p>
      <input type="password" id="adminPassword" placeholder="Digite sua senha" onkeypress="if(event.key==='Enter') login()" />
      <button class="btn btn-primary" onclick="login()">Entrar</button>
      <p class="login-error" id="loginError">Senha incorreta!</p>
      <p class="login-info" id="loginInfo"></p>
    </div>
  </div>

  <!-- PAINEL ADMIN -->
  <div id="admin-panel">
    <div class="container">
      <div class="alert">
        <strong>‚úÖ Admin Oficial - Integrado com Netlify</strong>
        <p>Autentica√ß√£o segura via Netlify Functions. Fa√ßa backup regularmente!</p>
      </div>

      <div class="header">
        <h1>Admin - Amaraltour</h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openAddModal()">+ Nova Viagem</button>
          <button class="btn btn-secondary" onclick="toggleExportData()">Exportar/Importar</button>
          <button class="btn btn-danger" onclick="logout()">Sair</button>
        </div>
      </div>

      <div class="content">
        <div id="loading">Carregando...</div>

        <div id="trips-container" class="trips-grid" style="display: none;"></div>

        <div id="empty-state" style="display: none;">
          <p>üì≠ Nenhuma viagem cadastrada ainda.</p>
          <p>Clique em "Nova Viagem" para come√ßar!</p>
        </div>

        <div id="export-section">
          <h3>Exportar/Importar Dados</h3>
          <textarea id="export-data" placeholder="Cole aqui o JSON para importar..."></textarea>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="copyExportData()">Copiar</button>
            <button class="btn btn-primary" onclick="downloadBackup()">Download</button>
            <button class="btn btn-secondary" onclick="importData()">Importar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL - Mesmo do admin-seguro.html -->
  <div id="trip-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title">Nova Viagem</h2>
      <form id="trip-form" onsubmit="saveTrip(event)">
        <div class="form-group">
          <label>T√≠tulo *</label>
          <input type="text" id="title" required />
        </div>

        <div class="form-group">
          <label>Data *</label>
          <input type="text" id="date" placeholder="Ex: 20 a 24 de Junho de 2026" required />
        </div>

        <div class="form-group">
          <label>Descri√ß√£o Curta *</label>
          <textarea id="description" required></textarea>
        </div>

        <div class="form-group">
          <label>Status *</label>
          <select id="status">
            <option value="available">Dispon√≠vel</option>
            <option value="sold_out">Esgotado</option>
          </select>
        </div>

        <div class="form-group">
          <label>Imagem *</label>
          <div class="image-upload" onclick="document.getElementById('imageInput').click()">
            <input type="file" id="imageInput" accept="image/*" onchange="processImage(this)" style="display: none;" />
            <p id="imagePlaceholder">Clique para selecionar uma imagem</p>
            <img id="imagePreview" class="image-preview" style="display: none;" />
            <input type="hidden" id="imageBase64" />
          </div>
        </div>

        <div class="form-group">
          <label>Introdu√ß√£o Completa</label>
          <textarea id="fullIntro"></textarea>
        </div>

        <div class="form-group">
          <label>Itens Inclusos</label>
          <textarea id="includedItems" placeholder="Ex: Transporte, Hospedagem..."></textarea>
        </div>

        <div class="form-group">
          <label>Pre√ßo</label>
          <input type="text" id="price" placeholder="Ex: R$ 1.500,00" />
        </div>

        <div class="form-group">
          <label>Informa√ß√µes de Pagamento</label>
          <textarea id="paymentInfo"></textarea>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ==========================================
    // AUTENTICA√á√ÉO VIA NETLIFY FUNCTION
    // ==========================================

    async function login() {
      const input = document.getElementById('adminPassword');
      const error = document.getElementById('loginError');
      const info = document.getElementById('loginInfo');
      const loginBtn = document.querySelector('#login-screen .btn-primary');

      // Limpa mensagens
      error.style.display = 'none';
      info.style.display = 'none';

      // Valida input
      if (!input.value.trim()) {
        error.textContent = 'Digite uma senha';
        error.style.display = 'block';
        return;
      }

      // Desabilita bot√£o
      loginBtn.disabled = true;
      loginBtn.textContent = 'Verificando...';

      try {
        console.log('üîê Enviando requisi√ß√£o para Netlify Function...');

        // Chama a Netlify Function
        const response = await fetch('/.netlify/functions/auth', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            password: input.value
          })
        });

        console.log('üì° Resposta recebida:', response.status);

        const result = await response.json();
        console.log('üì¶ Dados:', result);

        if (response.ok && result.authenticated) {
          // Login bem-sucedido!
          console.log('‚úÖ Autenticado com sucesso!');
          sessionStorage.setItem('admin_auth', 'true');
          sessionStorage.setItem('auth_timestamp', Date.now().toString());
          showAdminPanel();
        } else {
          // Senha incorreta
          console.log('‚ùå Senha incorreta');
          error.textContent = 'Senha incorreta!';
          error.style.display = 'block';
          input.value = '';
          loginBtn.disabled = false;
          loginBtn.textContent = 'Entrar';
        }
      } catch (err) {
        console.error('‚ùå Erro na autentica√ß√£o:', err);
        error.textContent = 'Erro ao conectar com servidor. Verifique o console.';
        error.style.display = 'block';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Entrar';
      }
    }

    function showAdminPanel() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      initSystem();
    }

    function logout() {
      sessionStorage.removeItem('admin_auth');
      sessionStorage.removeItem('auth_timestamp');
      location.reload();
    }

    // Verificar se j√° est√° autenticado
    window.addEventListener('load', () => {
      const isAuth = sessionStorage.getItem('admin_auth');
      const timestamp = sessionStorage.getItem('auth_timestamp');

      // Sess√£o expira em 2 horas
      const TWO_HOURS = 2 * 60 * 60 * 1000;

      if (isAuth === 'true' && timestamp) {
        const elapsed = Date.now() - parseInt(timestamp);
        if (elapsed < TWO_HOURS) {
          showAdminPanel();
        } else {
          sessionStorage.clear();
          alert('Sess√£o expirada. Fa√ßa login novamente.');
        }
      }
    });

    // ==========================================
    // SISTEMA DE GERENCIAMENTO (IGUAL AO SEGURO)
    // ==========================================

    let trips = [];
    let editingId = null;

    // ‚îÄ‚îÄ salva a lista atual no Blobs via Function ‚îÄ‚îÄ
    async function syncTrips() {
      const res = await fetch('/.netlify/functions/trips', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trips })
      });
      if (!res.ok) throw new Error('Erro ao salvar na nuvem');
    }

    function initSystem() {
      loadTrips();
    }

    async function loadTrips() {
      document.getElementById('loading').style.display = 'block';
      try {
        const res = await fetch('/.netlify/functions/trips');
        if (res.ok) {
          trips = await res.json();
        }
      } catch (err) {
        console.error('Erro ao carregar viagens:', err);
        trips = [];
      }
      renderTrips();
    }

    function renderTrips() {
      const container = document.getElementById('trips-container');
      const loading = document.getElementById('loading');
      const emptyState = document.getElementById('empty-state');

      loading.style.display = 'none';

      if (trips.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      container.style.display = 'grid';

      container.innerHTML = trips.map(trip => `
        <div class="trip-card">
          <span class="status ${trip.status === 'available' ? 'available' : 'sold-out'}">
            ${trip.status === 'available' ? 'Dispon√≠vel' : 'Esgotado'}
          </span>
          <h3>${trip.title}</h3>
          <p class="date">üìÖ ${trip.date}</p>
          <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
            ${trip.description ? trip.description.substring(0, 80) + '...' : 'Sem descri√ß√£o'}
          </p>
          <div class="actions">
            <button class="btn btn-primary" onclick="editTrip('${trip.id}')">Editar</button>
            <button class="btn btn-danger" onclick="deleteTrip('${trip.id}')">Excluir</button>
          </div>
        </div>
      `).join('');
    }

    function openAddModal() {
      editingId = null;
      document.getElementById('modal-title').textContent = 'Nova Viagem';
      document.getElementById('trip-form').reset();
      document.getElementById('imageBase64').value = '';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('imagePlaceholder').style.display = 'block';
      document.getElementById('trip-modal').classList.add('active');
    }

    function editTrip(id) {
      const trip = trips.find(t => t.id === id);
      if (!trip) return;

      editingId = id;
      document.getElementById('modal-title').textContent = 'Editar Viagem';
      document.getElementById('title').value = trip.title;
      document.getElementById('date').value = trip.date;
      document.getElementById('description').value = trip.description;
      document.getElementById('status').value = trip.status;

      document.getElementById('imageBase64').value = trip.image;
      document.getElementById('imagePreview').src = trip.image;
      document.getElementById('imagePreview').style.display = 'block';
      document.getElementById('imagePlaceholder').style.display = 'none';

      document.getElementById('fullIntro').value = trip.fullIntro || '';
      document.getElementById('includedItems').value = trip.includedItems || '';
      document.getElementById('price').value = trip.price || '';
      document.getElementById('paymentInfo').value = trip.paymentInfo || '';

      document.getElementById('trip-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('trip-modal').classList.remove('active');
      editingId = null;
    }

    function processImage(input) {
      if (input.files && input.files[0]) {
        const file = input.files[0];

        if (file.size > 5 * 1024 * 1024) {
          alert('‚ùå Imagem muito grande! Use uma imagem menor que 5MB.');
          input.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const maxWidth = 1920;
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
              height = Math.round(height * (maxWidth / width));
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

            document.getElementById('imageBase64').value = dataUrl;
            document.getElementById('imagePreview').src = dataUrl;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('imagePlaceholder').style.display = 'none';
          }
          img.src = e.target.result;
        }
        reader.readAsDataURL(file);
      }
    }

    async function saveTrip(event) {
      event.preventDefault();

      const imageValue = document.getElementById('imageBase64').value;
      if (!imageValue) {
        alert("‚ùå Por favor, selecione uma imagem para a viagem.");
        return;
      }

      const tripData = {
        id: editingId || Date.now().toString(),
        title: document.getElementById('title').value,
        date: document.getElementById('date').value,
        description: document.getElementById('description').value,
        image: imageValue,
        status: document.getElementById('status').value,
        fullIntro: document.getElementById('fullIntro').value || '',
        includedItems: document.getElementById('includedItems').value || '',
        price: document.getElementById('price').value || '',
        paymentInfo: document.getElementById('paymentInfo').value || '',
        link: `paginas-informacoes/detalhes-viagem.html?id=${editingId || Date.now().toString()}`,
        createdAt: editingId ? trips.find(t => t.id === editingId)?.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      if (editingId) {
        const index = trips.findIndex(t => t.id === editingId);
        if (index !== -1) {
          trips[index] = tripData;
        }
      } else {
        trips.push(tripData);
      }

      try {
        await syncTrips();
        alert(`‚úÖ Viagem salva com sucesso!\n\nüìä Total: ${trips.length} viagem(ns)`);
        closeModal();
        renderTrips();
      } catch (error) {
        alert('‚ùå Erro ao salvar: ' + error.message);
      }
    }

    async function deleteTrip(id) {
      const trip = trips.find(t => t.id === id);
      if (!trip) return;

      if (!confirm(`Excluir "${trip.title}"?`)) return;

      trips = trips.filter(t => t.id !== id);
      try {
        await syncTrips();
        alert('‚úÖ Viagem exclu√≠da!');
      } catch (err) {
        alert('‚ùå Erro ao excluir: ' + err.message);
      }
      renderTrips();
    }

    function toggleExportData() {
      const section = document.getElementById('export-section');
      const textarea = document.getElementById('export-data');

      if (section.style.display === 'none') {
        section.style.display = 'block';
        const exportData = {
          trips: trips,
          exportedAt: new Date().toISOString(),
          totalTrips: trips.length,
          version: '1.0.0'
        };
        textarea.value = JSON.stringify(exportData, null, 2);
      } else {
        section.style.display = 'none';
      }
    }

    async function importData() {
      const textarea = document.getElementById('export-data');
      const data = textarea.value.trim();

      if (!data) {
        alert('‚ùå Cole os dados no campo acima.');
        return;
      }

      try {
        const parsed = JSON.parse(data);
        const importedTrips = parsed.trips || parsed;

        if (!Array.isArray(importedTrips)) {
          throw new Error('Formato inv√°lido');
        }

        if (!confirm(`Importar ${importedTrips.length} viagem(ns)?\n\nIsso substituir√° as ${trips.length} atuais.`)) {
          return;
        }

        trips = importedTrips;
        await syncTrips();

        alert(`‚úÖ ${trips.length} viagem(ns) importada(s)!`);
        renderTrips();
        textarea.value = '';
        document.getElementById('export-section').style.display = 'none';
      } catch (error) {
        alert('‚ùå Erro ao importar: ' + error.message);
      }
    }

    function copyExportData() {
      const textarea = document.getElementById('export-data');
      textarea.select();
      document.execCommand('copy');
      alert('‚úÖ Copiado!');
    }

    function downloadBackup() {
      const exportData = {
        trips: trips,
        exportedAt: new Date().toISOString(),
        totalTrips: trips.length,
        version: '1.0.0'
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `amaraltour-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);

      alert('‚úÖ Backup baixado!');
    }
  </script>
</body>

</html>